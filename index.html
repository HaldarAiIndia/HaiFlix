<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>HaiFlix</title>

    <!-- SEO Meta -->
    <meta name="description" content="HaiFlix is your home for unlimited movies, trending webseries, and ultra-fast Live TV streaming. Watch anytime, anywhere — no limits." />
    <meta name="robots" content="index, follow" />

    <!-- Canonical -->
    <link rel="canonical" href="https://haiflix.vercel.app/" />

    <!-- Open Graph -->
    <meta property="og:title" content="HaiFlix – Stream Movies & Live TV" />
    <meta property="og:description" content="HaiFlix is your home for unlimited movies, trending webseries, and ultra-fast Live TV streaming. Watch anytime, anywhere — no limits." />
    <meta property="og:image" content="/favicon.png" />
    <meta property="og:url" content="https://haiflix.vercel.app/" />
    <meta property="og:type" content="website" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="HaiFlix – Unlimited Movies & Live TV" />
    <meta name="twitter:description" content="HaiFlix is your home for unlimited movies, trending webseries, and ultra-fast Live TV streaming. Watch anytime, anywhere — no limits." />
    <meta name="twitter:image" content="/favicon.png" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png" />

    <meta name="theme-color" content="#000000" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <script src="https://ajax.googleapis.com/ajax/libs/shaka-player/4.3.4/shaka-player.compiled.js"></script>
    <style>
        /* Updated to HaiFlix Red */
        :root { --primary: #E50914; --background: #000000; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background); color: #f8fafc; }
        
        /* Darker Glass Effect */
        .glass { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .aspect-poster { aspect-ratio: 2/3; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #splash-screen { transition: opacity 0.6s ease-out, visibility 0.6s; }
        
        /* Red Pulse Animation */
        @keyframes pulse-glow { 50% { box-shadow: 0 0 0 20px rgba(229, 9, 20, 0); transform: scale(1.05); } }
        .splash-logo { animation: pulse-glow 2s infinite; }
        
        .animate-fade-up { animation: fade-up 0.8s ease-out forwards; }
        @keyframes fade-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Logo Typography matching image */
        .brand-logo { font-weight: 800; letter-spacing: -0.05em; }
        .text-brand-red { color: #E50914; }
    </style>
</head>
<body class="antialiased pb-20 md:pb-0 selection:bg-red-600 selection:text-white">

<div id="splash-screen" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center">
    <div class="relative z-10 flex flex-col items-center">
        <!-- Updated Splash Logo with New Image URL -->
        <div class="splash-logo w-28 h-28 rounded-2xl p-0.5 border-2 border-red-600 overflow-hidden mb-6 bg-zinc-900 shadow-2xl shadow-red-600/40 animate-fade-up">
            <img src="https://i.ibb.co/twwV3QB7/favicon.png" class="w-full h-full object-cover">
        </div>
        <h1 class="text-4xl md:text-5xl font-black text-white tracking-tighter mb-2 animate-fade-up brand-logo" style="animation-delay:0.1s">
            Hai<span class="text-brand-red">Flix</span>
        </h1>
        <p class="text-zinc-500 text-sm md:text-base tracking-wide animate-fade-up" style="animation-delay:0.2s">Unlimited Streaming World</p>
    </div>
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-red-900/20 via-black to-black"></div>
</div>

<div id="app" class="flex flex-col min-h-screen">
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/80 z-50 hidden opacity-0 backdrop-blur-sm"></div>
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-zinc-950 border-r border-zinc-800 transform -translate-x-full shadow-2xl flex flex-col">
        <div class="p-6 flex flex-col items-center border-b border-zinc-800/50 bg-zinc-950">
            <!-- Sidebar Logo with New Image URL -->
            <div class="w-16 h-16 rounded-xl p-0.5 border-2 border-red-600 overflow-hidden mb-3 shadow-lg shadow-red-600/20">
                <img src="https://i.ibb.co/twwV3QB7/favicon.png" class="w-full h-full object-cover">
            </div>
            <h2 class="text-2xl font-black tracking-tighter text-white brand-logo">Hai<span class="text-brand-red">Flix</span></h2>
        </div>
        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <button data-section="movies" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-bold rounded-xl text-zinc-400 hover:bg-white/10 hover:text-white transition-all"><i data-lucide="film" class="w-5 h-5 mr-3 text-red-500"></i> Movies</button>
            <button data-section="series" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-bold rounded-xl text-zinc-400 hover:bg-white/10 hover:text-white transition-all"><i data-lucide="tv" class="w-5 h-5 mr-3 text-red-500"></i> Series</button>
            <button data-section="livetv" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-bold rounded-xl text-zinc-400 hover:bg-white/10 hover:text-white transition-all"><i data-lucide="satellite-dish" class="w-5 h-5 mr-3 text-red-500"></i> Live TV</button>
            <div class="my-4 border-t border-zinc-800/50"></div>
            <a href="https://HaiFlix.vercel.app/review" target="_blank" class="w-full flex items-center px-4 py-3 text-sm font-medium rounded-xl text-zinc-400 hover:bg-white/10 hover:text-white transition-all"><i data-lucide="message-square" class="w-5 h-5 mr-3 text-zinc-500"></i> Request / Review</a>
        </nav>
        <div class="p-4 border-t border-zinc-800/50 text-center text-xs text-zinc-600">&copy; 2024 HaiFlix</div>
    </aside>

    <header class="sticky top-0 z-40 glass shadow-md shadow-black/50">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button id="menu-toggle" class="p-2 -ml-2 text-zinc-300 hover:text-white hover:bg-white/10 rounded-full transition-colors"><i data-lucide="menu" class="w-6 h-6"></i></button>
                
                <!-- Header Branding with Image -->
                <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
                    <div class="w-8 h-8 rounded-lg p-0.5 border border-red-600/50 overflow-hidden bg-zinc-900 hidden xs:block">
                        <img src="https://i.ibb.co/twwV3QB7/favicon.png" class="w-full h-full object-cover">
                    </div>
                    <span class="font-black text-2xl tracking-tighter text-white hidden xs:block brand-logo">Hai<span class="text-brand-red">Flix</span></span>
                </div>

                <nav class="hidden md:flex ml-8 gap-1">
                    <button data-section="movies" class="nav-item px-4 py-2 rounded-lg text-sm font-bold text-zinc-400 hover:text-white hover:bg-white/10 transition-all">Movies</button>
                    <button data-section="series" class="nav-item px-4 py-2 rounded-lg text-sm font-bold text-zinc-400 hover:text-white hover:bg-white/10 transition-all">Series</button>
                    <button data-section="livetv" class="nav-item px-4 py-2 rounded-lg text-sm font-bold text-zinc-400 hover:text-white hover:bg-white/10 transition-all">Live TV</button>
                </nav>
            </div>
            <button id="search-toggle" class="p-2 text-zinc-300 hover:text-red-500 hover:bg-white/5 rounded-full transition-colors"><i data-lucide="search" class="w-5 h-5"></i></button>
        </div>
        
        <div id="search-bar" class="hidden border-t border-zinc-800 bg-black/95 backdrop-blur-xl absolute w-full left-0 top-16 shadow-2xl z-[60]">
            <div class="container mx-auto px-4 py-3 relative">
                <div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500"></i><input type="text" id="search-input" autocomplete="off" placeholder="Titles, people, genres..." class="w-full bg-zinc-900 text-white pl-10 pr-10 py-3 rounded-none border-b border-zinc-700 focus:border-red-600 outline-none transition-all placeholder:text-zinc-600"><button id="search-close-internal" class="absolute right-3 top-1/2 -translate-y-1/2 text-zinc-400 hover:text-white hidden"><i data-lucide="x" class="w-4 h-4"></i></button></div>
                <div id="search-results" class="hidden absolute top-full left-0 right-0 mt-0 bg-zinc-950 border-b border-zinc-800 shadow-2xl overflow-hidden max-h-[60vh] overflow-y-auto z-[70]"></div>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6 space-y-8">
        <div id="banner-section" class="relative w-full aspect-video md:aspect-[2.5/1] rounded-xl overflow-hidden shadow-2xl shadow-red-900/10 bg-zinc-900 ring-1 ring-white/5"><div id="banner-slider" class="w-full h-full"></div><div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div><div class="absolute bottom-0 left-0 p-6 md:p-10 w-full md:w-2/3"><h2 class="text-3xl md:text-5xl font-black text-white mb-3 drop-shadow-lg tracking-tight">Welcome to <span class="text-red-600">HaiFlix</span></h2><p class="text-sm md:text-lg text-zinc-300 line-clamp-2 drop-shadow-md font-medium">Unlimited movies, TV shows, and more. Watch anywhere. Cancel anytime.</p></div></div>
        <div id="movies-section" class="space-y-8 animate-fade-in"></div>
        <div id="series-section" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"></div>
        <div id="livetv-section" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-4"></div>
    </main>

    <nav class="md:hidden fixed bottom-0 inset-x-0 bg-black/95 backdrop-blur-xl border-t border-zinc-800 z-40 safe-area-pb shadow-2xl">
        <div class="flex justify-around items-center h-16">
            <button data-section="movies" class="nav-item-mobile flex-1 flex flex-col items-center justify-center gap-1 text-red-600 transition-colors"><i data-lucide="film" class="w-5 h-5"></i><span class="text-[10px] font-bold">Movies</span></button>
            <button data-section="series" class="nav-item-mobile flex-1 flex flex-col items-center justify-center gap-1 text-zinc-500 hover:text-zinc-300 transition-colors"><i data-lucide="tv" class="w-5 h-5"></i><span class="text-[10px] font-medium">Series</span></button>
            <button data-section="livetv" class="nav-item-mobile flex-1 flex flex-col items-center justify-center gap-1 text-zinc-500 hover:text-zinc-300 transition-colors"><i data-lucide="satellite-dish" class="w-5 h-5"></i><span class="text-[10px] font-medium">Live TV</span></button>
        </div>
    </nav>
</div>

<div id="player-modal" class="fixed inset-0 z-50 bg-black hidden">
    <div class="flex flex-col lg:flex-row h-full">
        <div class="w-full lg:w-3/4 h-[40vh] lg:h-full bg-black relative flex items-center justify-center group shrink-0">
            <button id="close-player" class="absolute top-4 left-4 z-20 p-2 bg-black/50 hover:bg-red-600 text-white rounded-full backdrop-blur-sm transition-all opacity-100 lg:opacity-0 lg:group-hover:opacity-100"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <video id="video-player" controls class="w-full h-full max-h-screen hidden outline-none"></video>
            <iframe id="iframe-player" class="w-full h-full border-0 hidden" allowfullscreen allow="autoplay; encrypted-media"></iframe>
        </div>
        <div class="w-full lg:w-1/4 flex-1 lg:h-full bg-zinc-950 border-l border-zinc-800 flex flex-col min-h-0">
            <div class="p-5 border-b border-zinc-800 shrink-0"><h2 id="player-title" class="text-xl font-bold text-white mb-1 line-clamp-2">Loading...</h2><span class="px-2 py-1 bg-red-600/20 text-red-500 text-xs rounded uppercase font-bold tracking-wider border border-red-600/30">Now Playing</span></div>
            <div class="flex-1 overflow-y-auto p-4 scrollbar-hide"><h3 id="related-title" class="text-sm font-bold text-zinc-500 uppercase tracking-wider mb-3">Related</h3><div id="related-container" class="grid grid-cols-2 gap-3"></div></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDhdItehDKZJT7Ihqb-AjUtZVT7yOfYKtA", authDomain: "filmx-bfac5.firebaseapp.com", databaseURL: "https://filmx-bfac5-default-rtdb.firebaseio.com", projectId: "filmx-bfac5", storageBucket: "filmx-bfac5.appspot.com", messagingSenderId: "506741430153", appId: "1:506741430153:web:d5590373c9ca74c595b358" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let shakaPlayer = null;
    const contentCache = { movies: [], series: [], livetv: [] };

    function initShaka() { shaka.polyfill.installAll(); if (!shaka.Player.isBrowserSupported()) console.error('Shaka not supported'); }
    initShaka();

    if (!sessionStorage.getItem('splashShown')) {
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0'; splash.style.visibility = 'hidden';
            setTimeout(() => splash.remove(), 600);
            sessionStorage.setItem('splashShown', 'true');
        }, 3000);
    } else { document.getElementById('splash-screen').style.display = 'none'; }

    const ui = {
        sections: { movies: document.getElementById('movies-section'), series: document.getElementById('series-section'), livetv: document.getElementById('livetv-section') },
        searchBar: document.getElementById('search-bar'), searchInput: document.getElementById('search-input'), searchResults: document.getElementById('search-results'), searchCloseInternal: document.getElementById('search-close-internal'),
        bannerSlider: document.getElementById('banner-slider'), playerModal: document.getElementById('player-modal'), videoPlayer: document.getElementById('video-player'), iframePlayer: document.getElementById('iframe-player'),
        playerTitle: document.getElementById('player-title'), relatedTitle: document.getElementById('related-title'), relatedContainer: document.getElementById('related-container'),
        sidebar: document.getElementById('sidebar'), sidebarOverlay: document.getElementById('sidebar-overlay'), menuToggle: document.getElementById('menu-toggle')
    };

    // Sidebar
    const toggleSidebar = (show) => { if(show){ui.sidebar.classList.remove('-translate-x-full');ui.sidebarOverlay.classList.remove('hidden');setTimeout(()=>ui.sidebarOverlay.classList.remove('opacity-0'),10);}else{ui.sidebar.classList.add('-translate-x-full');ui.sidebarOverlay.classList.add('opacity-0');setTimeout(()=>ui.sidebarOverlay.classList.add('hidden'),300);} };
    ui.menuToggle.onclick = () => toggleSidebar(true);
    ui.sidebarOverlay.onclick = () => toggleSidebar(false);
    document.querySelectorAll('.sidebar-item').forEach(btn => btn.onclick = () => { setActiveNav(btn.dataset.section); toggleSidebar(false); });

    // Search
    const toggleSearch = (show) => { if(show){ui.searchBar.classList.remove('hidden');ui.searchInput.focus();}else{ui.searchBar.classList.add('hidden');ui.searchInput.value='';ui.searchResults.classList.add('hidden');ui.searchCloseInternal.classList.add('hidden');} };
    document.getElementById('search-toggle').onclick = () => toggleSearch(ui.searchBar.classList.contains('hidden'));
    ui.searchCloseInternal.onclick = () => { ui.searchInput.value=''; ui.searchInput.focus(); ui.searchResults.classList.add('hidden'); ui.searchCloseInternal.classList.add('hidden'); };
    
    let debounceTimer;
    ui.searchInput.oninput = (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const q = e.target.value.toLowerCase().trim();
            if(q.length>0) ui.searchCloseInternal.classList.remove('hidden'); else ui.searchCloseInternal.classList.add('hidden');
            if(q.length<2){ui.searchResults.classList.add('hidden');return;}
            
            const allContent = [...contentCache.movies.map(i=>({...i,type:'movies'})), ...contentCache.series.map(i=>({...i,type:'series'})), ...contentCache.livetv.map(i=>({...i,type:'livetv'}))];
            const results = allContent.filter(i=>i.name.toLowerCase().includes(q));

            if(results.length>0) {
                ui.searchResults.innerHTML = results.map(item => `
                <div class="flex items-center gap-3 p-3 hover:bg-zinc-800 cursor-pointer border-b border-zinc-800 last:border-0 transition-colors" onclick="window.playContent('${item.id}', '${item.type}')">
                    <div class="w-12 h-16 rounded-md overflow-hidden bg-zinc-800 flex-shrink-0"><img src="${item.imageUrl}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100x140/111/666?text=?'"></div>
                    <div>
                        <h4 class="text-sm font-bold text-white line-clamp-1">${item.name}</h4>
                        <span class="text-[10px] text-red-500 uppercase font-bold tracking-wider">
                            ${item.type==='livetv' ? 'Channel' : (item.catalogue || item.type.toUpperCase())}
                        </span>
                    </div>
                </div>`).join('');
            } else { ui.searchResults.innerHTML = '<div class="p-4 text-zinc-500 text-center text-sm font-medium">No matches found.</div>'; }
            ui.searchResults.classList.remove('hidden');
        }, 300);
    };

    // Skeletons & Nav
    const getSkeletonCards = (count, type='poster') => {
        const aspect = type==='livetv'?'aspect-video':'aspect-[2/3]'; const width = type==='livetv'?'w-full':(type==='row'?'w-32 md:w-44':'w-full');
        return Array(count).fill(`<div class="flex-shrink-0 ${width} animate-pulse"><div class="${aspect} bg-zinc-800 rounded-md mb-3"></div><div class="h-3 bg-zinc-800 rounded w-3/4 mb-2"></div><div class="h-2 bg-zinc-800 rounded w-1/2"></div></div>`).join('');
    };
    function renderSkeletons() {
        ui.bannerSlider.innerHTML = `<div class="w-full h-full bg-zinc-800 animate-pulse"></div>`;
        ui.sections.movies.innerHTML = `<div><div class="flex mb-4 px-2"><div class="h-6 w-32 bg-zinc-800 rounded animate-pulse border-l-4 border-red-600 pl-3"></div></div><div class="flex overflow-x-auto gap-4 pb-4 scrollbar-hide px-2 snap-x">${getSkeletonCards(6,'row')}</div></div>`;
        ui.sections.series.innerHTML = getSkeletonCards(12,'poster'); ui.sections.livetv.innerHTML = getSkeletonCards(12,'livetv');
    }
    const setActiveNav = (sec) => {
        document.querySelectorAll('.nav-item').forEach(b => b.dataset.section === sec ? b.classList.add('text-white') : b.classList.remove('text-white'));
        document.querySelectorAll('.nav-item-mobile').forEach(b => { if(b.dataset.section === sec) { b.classList.add('text-red-600'); b.classList.remove('text-zinc-500'); } else { b.classList.remove('text-red-600'); b.classList.add('text-zinc-500'); } });
        document.querySelectorAll('.sidebar-item').forEach(b => b.dataset.section === sec ? b.classList.add('bg-white/10', 'text-white') : b.classList.remove('bg-white/10', 'text-white'));
        Object.values(ui.sections).forEach(el => el.classList.add('hidden')); ui.sections[sec].classList.remove('hidden');
        document.getElementById('banner-section').style.display = sec === 'movies' ? 'block' : 'none';
    };
    document.querySelectorAll('[data-section]').forEach(b => b.onclick = () => setActiveNav(b.dataset.section));

    // Fetch
    const createCard = (item, type) => {
        const isLive = type==='livetv'; const aspect = isLive?'aspect-video':'aspect-poster'; const sub = type==='movies'?(item.catalogue||'Movie'):(type==='series'?'Series':'Live Stream');
        return `<div class="group cursor-pointer" onclick="window.playContent('${item.id}', '${type}')">
            <div class="relative ${aspect} rounded-md overflow-hidden bg-zinc-900 mb-2 shadow-lg border border-transparent hover:border-zinc-700 transition-all">
                <img src="${item.imageUrl}" loading="lazy" class="w-full h-full object-cover transform transition-transform duration-500 group-hover:scale-110">
                <div class="absolute inset-0 bg-black/20 group-hover:bg-black/40 transition-colors"></div>
                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300"><div class="bg-red-600 rounded-full p-3 shadow-xl transform scale-75 group-hover:scale-100 transition-transform"><i data-lucide="play" class="w-5 h-5 text-white fill-current"></i></div></div>
                ${isLive ? '<div class="absolute top-2 left-2 bg-red-600 text-white text-[9px] font-black px-1.5 py-0.5 rounded uppercase tracking-wider shadow-sm">Live</div>' : ''}
            </div>
            <h3 class="font-bold text-sm text-gray-200 truncate group-hover:text-white transition-colors">${item.name}</h3>
            <p class="text-xs text-zinc-500 truncate font-medium">${sub}</p>
        </div>`;
    };
    async function fetchData() {
        renderSkeletons();
        try {
            const bSnap = await getDocs(collection(db, 'banners'));
            if(!bSnap.empty) { const bans = bSnap.docs.map(d=>d.data().url); let bI=0; const rot=()=>{ui.bannerSlider.innerHTML=`<img src="${bans[bI]}" class="w-full h-full object-cover animate-fade">`;bI=(bI+1)%bans.length;}; rot(); setInterval(rot,5000); }
            const mSnap = await getDocs(query(collection(db, 'movies'), where('isPublic', '==', true)));
            const mCat = {}; contentCache.movies=[]; mSnap.forEach(d=>{ const data=d.data(); const cat=data.catalogue||'Latest'; if(!mCat[cat])mCat[cat]=[]; const m={id:d.id,...data}; mCat[cat].push(m); contentCache.movies.push(m); });
            ui.sections.movies.innerHTML = Object.entries(mCat).map(([cat, items]) => `<div><div class="flex items-center justify-between mb-3 px-1"><h2 class="text-lg font-bold text-white border-l-4 border-red-600 pl-3 tracking-tight">${cat}</h2></div><div class="flex overflow-x-auto gap-4 pb-4 scrollbar-hide px-1 snap-x">${items.map(i => `<div class="snap-start flex-shrink-0 w-32 md:w-44">${createCard(i,'movies')}</div>`).join('')}</div></div>`).join('');
            const sSnap = await getDocs(query(collection(db, 'series'), where('isPublic', '==', true))); contentCache.series = sSnap.docs.map(d=>({id:d.id,...d.data()})); ui.sections.series.innerHTML = contentCache.series.map(i=>createCard(i,'series')).join('');
            const lSnap = await getDocs(query(collection(db, 'livetv'), where('isPublic', '==', true))); contentCache.livetv = lSnap.docs.map(d=>({id:d.id,...d.data()})); ui.sections.livetv.innerHTML = contentCache.livetv.map(i=>createCard(i,'livetv')).join('');
            lucide.createIcons();
        } catch(e) { console.error(e); }
    }

    // Player
    window.playContent = async (id, type) => {
        toggleSearch(false);
        let data = null;
        if(type==='movies') data=contentCache.movies.find(i=>i.id===id); else if(type==='series') data=contentCache.series.find(i=>i.id===id); else data=contentCache.livetv.find(i=>i.id===id);
        if(!data) { const docSnap = await getDoc(doc(db, type, id)); if(docSnap.exists()) data=docSnap.data(); else return; }

        ui.playerTitle.textContent = data.name;
        ui.playerModal.classList.remove('hidden');
        if(shakaPlayer) { await shakaPlayer.destroy(); shakaPlayer=null; }
        ui.videoPlayer.classList.add('hidden'); ui.videoPlayer.pause(); ui.iframePlayer.classList.add('hidden'); ui.iframePlayer.src='';

        let relatedHtml = ''; ui.relatedTitle.textContent = 'Related';
        if(type==='series') {
            ui.relatedTitle.textContent = 'Episodes';
            relatedHtml = (data.episodes||[]).map((ep,i) => `<div class="group cursor-pointer bg-zinc-900 rounded-md overflow-hidden border border-zinc-800 hover:border-red-600 transition-all" onclick="playDirect('${ep.url}')"><div class="relative aspect-video"><img src="${ep.imageUrl||data.imageUrl}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100"><div class="absolute inset-0 flex items-center justify-center bg-black/30 group-hover:bg-transparent"><i data-lucide="play" class="w-5 h-5 text-white"></i></div></div><div class="p-2 bg-zinc-900"><span class="block text-xs font-bold text-zinc-300 truncate group-hover:text-red-500">Episode ${i+1}</span></div></div>`).join('');
            if(data.episodes?.length) playDirect(data.episodes[0].url);
        } else {
            let rel = [];
            if(type==='movies') rel = contentCache.movies.filter(m=>m.catalogue===data.catalogue && m.id!==data.id).slice(0,20);
            else if(type==='livetv') rel = contentCache.livetv.filter(l=>l.id!==data.id).slice(0,20);
            relatedHtml = rel.length ? rel.map(i => `<div class="group cursor-pointer" onclick="window.playContent('${i.id}', '${type}')"><div class="relative ${type==='livetv'?'aspect-video':'aspect-poster'} rounded-md overflow-hidden bg-zinc-900 mb-1 border border-transparent group-hover:border-red-600"><img src="${i.imageUrl}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/20 group-hover:bg-black/0"></div></div><h4 class="text-xs font-bold text-zinc-400 group-hover:text-white truncate">${i.name}</h4></div>`).join('') : `<div class="col-span-2 text-xs text-zinc-600 italic text-center py-4">No related content.</div>`;
            
            const url = type==='movies'?data.movieUrl:data.liveTvUrl;
            if(data.sourceType==='iframe'){ui.iframePlayer.classList.remove('hidden');ui.iframePlayer.src=url;} else playDirect(url, data.key, data.kid, data.sourceType==='mpd');
        }
        ui.relatedContainer.innerHTML = relatedHtml;
        lucide.createIcons();
    };

    window.playDirect = async (url, key, kid, isMpd) => {
        ui.videoPlayer.classList.remove('hidden');
        if(isMpd || url.includes('.mpd')) {
            shakaPlayer = new shaka.Player(ui.videoPlayer);
            if(key && kid) shakaPlayer.configure({drm:{clearKeys:{[kid]:key}}});
            try{await shakaPlayer.load(url);ui.videoPlayer.play();}catch(e){console.error(e);}
        } else { ui.videoPlayer.src = url; ui.videoPlayer.play(); }
    };

    document.getElementById('close-player').onclick = () => { ui.playerModal.classList.add('hidden'); ui.videoPlayer.pause(); ui.iframePlayer.src=''; };
    fetchData(); setActiveNav('movies');
</script>
<style>.animate-fade{animation: fade 1s ease-in-out;} @keyframes fade{from{opacity:0.8}to{opacity:1}}</style>
</body>
</html>
